%% Repo Map（リポジトリ地図）
%% 作成日: 2026-02-07
%% 参照: README, 入口ファイル, 主要ディレクトリ
%% 抽象化: ディレクトリ中心 / 代表ファイルは各subgraph最大2 / flowchart TB 固定
%% 依存矢印: ラベル必須 / 多重エッジ禁止 / 読取+書込は I/O（読取・書込）に統合
%% 記法: ==>（主要フロー）, ~~~（整列用・非依存）
%%{init: {'flowchart': {'nodeSpacing': 70, 'rankSpacing': 90, 'curve': 'linear'}}}%%
flowchart TB

classDef entry fill:#E3F2FD,stroke:#64B5F6,stroke-width:1px
classDef app fill:#E0F7FA,stroke:#4DD0E1,stroke-width:1px
classDef domain fill:#E8F5E9,stroke:#81C784,stroke-width:1px
classDef infra fill:#FFF3E0,stroke:#FFB74D,stroke-width:1px
classDef shared fill:#F3E5F5,stroke:#BA68C8,stroke-width:1px
classDef config fill:#ECEFF1,stroke:#90A4AE,stroke-width:1px
classDef res_db fill:#EDE7F6,stroke:#9575CD,stroke-width:1px
classDef res_cache fill:#E8EAF6,stroke:#7986CB,stroke-width:1px
classDef res_queue fill:#FFFDE7,stroke:#FFD54F,stroke-width:1px
classDef res_external fill:#F5F5F5,stroke:#9E9E9E,stroke-width:1px
classDef group_title fill:#FFFFFF,stroke:#B0BEC5,stroke-width:2px,font-weight:bold

%% ============================================================
%% Groups
%% ============================================================

subgraph SG_ENTRY[" "]
  direction TB
  hdr_entry["ENTRY<br/>入口/起動点<br/>対応: frontend/, backend/websocket/, backend/s3-events/"]:::group_title

  ep_frontend["Frontend (Web UI)<br/>frontend/src/app/<br/>操作を受け付ける"]:::entry
  ep_ws_gateway["WebSocket Gateway<br/>backend/websocket/websocket_server.py<br/>接続要求を受け付ける"]:::entry
  ep_s3_worker["S3 Event Worker<br/>backend/s3-events/src/main.py<br/>イベント処理を開始する"]:::entry
end

subgraph SG_APP[" "]
  direction TB
  hdr_app["APP<br/>アプリ層/ユースケース<br/>対応: backend/websocket/src/api/, backend/s3-events/src/processors/"]:::group_title

  app_realtime_uc["Realtime Usecases<br/>backend/websocket/src/api/…<br/>要求処理を編成する"]:::app
  app_s3_processor["S3 Event Processor<br/>backend/s3-events/src/processors/<br/>イベント処理を編成する"]:::app
end

subgraph SG_DOMAIN[" "]
  direction TB
  hdr_domain["DOMAIN<br/>ドメイン/ビジネスルール<br/>対応: backend/websocket/src/usecases/, src/pptx_pipeline/"]:::group_title

  dom_agent_flow["Agent Workflow<br/>backend/websocket/src/usecases/…<br/>議論フローを実行する"]:::domain
  dom_pptx_core["PPTX Pipeline<br/>src/pptx_pipeline/<br/>変換規則を適用する"]:::domain
end

subgraph SG_INFRA[" "]
  direction TB
  hdr_infra["INFRA<br/>インフラ/外部接続<br/>対応: backend/websocket/src/database/, backend/*/src/file_handlers/"]:::group_title

  inf_persistence["Persistence (Repo/CRUD)<br/>backend/websocket/src/database/…<br/>永続データI/Oを担う"]:::infra
  inf_object_storage["Object Storage Adapter<br/>backend/*/src/file_handlers/<br/>外部ファイルI/Oを担う"]:::infra
end

subgraph SG_SHARED[" "]
  direction TB
  hdr_shared["SHARED<br/>共通<br/>対応: frontend/src/lib/, backend/websocket/src/core/"]:::group_title

  sh_common["Common / DI / Security<br/>backend/websocket/src/core/…<br/>横断関心を提供する"]:::shared
end

subgraph SG_CONFIG[" "]
  direction TB
  hdr_config["CONFIG<br/>設定<br/>対応: .env*, terraform/environments/"]:::group_title

  cfg_runtime["Runtime / Infra Config<br/>frontend/.env* + terraform/…<br/>設定値を供給する"]:::config
end

%% ============================================================
%% External Resources
%% ============================================================

res_db_datastore[(DB(PostgreSQL/DynamoDB)<br/>backend/websocket/src/database + crud/<br/>永続化先として振る舞う)]:::res_db
res_queue_eventbridge[[Queue(EventBridge)<br/>terraform/modules/eventbridge/<br/>S3イベントを配信する]]:::res_queue
res_external_s3[/External(S3)<br/>backend/*/src/file_handlers/<br/>ファイル保管先として振る舞う/]:::res_external
res_external_azure_openai[/External(Azure OpenAI)<br/>backend/*/src/models/…<br/>推論先として振る舞う/]:::res_external

%% ============================================================
%% Layout anchors (non-dependency)
%% ============================================================

hdr_entry ~~~ hdr_app ~~~ hdr_domain ~~~ hdr_infra ~~~ hdr_shared ~~~ hdr_config
hdr_config ~~~ res_db_datastore ~~~ res_queue_eventbridge ~~~ res_external_s3 ~~~ res_external_azure_openai

%% ============================================================
%% Dependencies (labeled, no multi-edge)
%% ============================================================

ep_frontend ==>|HTTP| ep_ws_gateway
ep_ws_gateway ==>|呼出| app_realtime_uc

ep_s3_worker ==>|呼出| app_s3_processor
ep_s3_worker -->|消費| res_queue_eventbridge

app_realtime_uc ==>|呼出| dom_agent_flow
app_realtime_uc -->|呼出| dom_pptx_core
app_realtime_uc -->|呼出（import）| sh_common
app_realtime_uc -->|設定| cfg_runtime

app_s3_processor -->|呼出| inf_object_storage
app_s3_processor -->|RPC| res_external_azure_openai
app_s3_processor -->|呼出（import）| sh_common
app_s3_processor -->|設定| cfg_runtime

dom_agent_flow ==>|RPC| res_external_azure_openai
dom_agent_flow -->|呼出| inf_persistence
dom_agent_flow -->|呼出| inf_object_storage

dom_pptx_core -->|呼出| inf_object_storage

inf_persistence -->|I/O（読取・書込）| res_db_datastore
inf_object_storage -->|I/O（読取・書込）| res_external_s3

ep_ws_gateway -->|呼出（import）| sh_common
ep_ws_gateway -->|設定| cfg_runtime
ep_s3_worker -->|設定| cfg_runtime

%% ============================================================
%% Legend
%% ============================================================

subgraph SG_LEGEND[" "]
  direction TB
  hdr_legend["LEGEND<br/>図の読み方<br/>対応: 色分けと矢印ルール"]:::group_title

  lg_color["Color<br/>entry/app/domain/infra/shared/config/res_*<br/>種別ごとに色分けする"]:::shared
  lg_rule["Arrow/Rule<br/>-->確認 / -.->推定(依存?) / ==>主要フロー / ~~~整列用<br/>同一A→Bは1本・I/Oは統合"]:::shared
end

%% ============================================================
%% Subgraph style
%% ============================================================

style SG_ENTRY fill:#FBFBFB,stroke:#DADADA,stroke-width:1px
style SG_APP fill:#FBFBFB,stroke:#DADADA,stroke-width:1px
style SG_DOMAIN fill:#FBFBFB,stroke:#DADADA,stroke-width:1px
style SG_INFRA fill:#FBFBFB,stroke:#DADADA,stroke-width:1px
style SG_SHARED fill:#FBFBFB,stroke:#DADADA,stroke-width:1px
style SG_CONFIG fill:#FBFBFB,stroke:#DADADA,stroke-width:1px
style SG_LEGEND fill:#FBFBFB,stroke:#DADADA,stroke-width:1px
